// Prisma schema for Healthcare Messaging Platform
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  DOCTOR
  PATIENT
  ADMIN
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  role         Role
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  patientProfile PatientProfile?
  doctorProfile  DoctorProfile?
  
  // Conversations where user is a patient
  patientConversations Conversation[] @relation("PatientConversations")
  // Conversations where user is a doctor
  doctorConversations  Conversation[] @relation("DoctorConversations")
  
  sentMessages Message[] @relation("SentMessages")
  auditLogs    AuditLog[]
}

model PatientProfile {
  id          String    @id @default(cuid())
  userId      String    @unique
  fullName    String
  dateOfBirth DateTime?
  phone       String?
  address     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DoctorProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  fullName     String
  specialty    String
  hospitalName String?
  licenseNumber String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Conversation {
  id        String             @id @default(cuid())
  doctorId  String
  patientId String
  status    ConversationStatus @default(ACTIVE)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  doctor   User @relation("DoctorConversations", fields: [doctorId], references: [id], onDelete: Cascade)
  patient  User @relation("PatientConversations", fields: [patientId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([doctorId, patientId])
  @@index([doctorId])
  @@index([patientId])
}

model Message {
  id             String    @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  attachmentUrl  String?
  attachmentName String?
  createdAt      DateTime  @default(now())
  readAt         DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String
  details    String?
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
}
